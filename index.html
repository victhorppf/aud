<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PolarAUD - Sistema de Auditoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .notification {
            transition: all 0.5s ease-in-out;
        }
        .notification-enter {
            opacity: 0;
            transform: translateX(100%);
        }
        .notification-enter-active {
            opacity: 1;
            transform: translateX(0);
        }
        .notification-exit {
            opacity: 1;
            transform: translateX(0);
        }
        .notification-exit-active {
            opacity: 0;
            transform: translateX(100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      // Importações do Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { 
        getAuth, 
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        sendPasswordResetEmail
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
      import { 
        getFirestore, 
        doc, 
        setDoc, 
        getDoc,
        addDoc,
        collection,
        query,
        where,
        getDocs,
        serverTimestamp,
        writeBatch,
        updateDoc,
        deleteDoc
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      // =================================================================================
      // COLE AQUI A CONFIGURAÇÃO DO SEU FIREBASE
      // =================================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyABacusGuCXnA3b0uLyQPKgiRXUHiqbXC8", // USE A SUA CHAVE
        authDomain: "polaraud-app.firebaseapp.com",
        projectId: "polaraud-app",
        storageBucket: "polaraud-app.appspot.com",
        messagingSenderId: "891816680442",
        appId: "1:891816680442:web:0017a9878182374b79e243",
        measurementId: "G-SQBWLWQH7K"
      };
      
      // =================================================================================
      // COLE AQUI A URL DA SUA API DO GOOGLE APPS SCRIPT
      // =================================================================================
      const IMAGE_API_URL = 'https://script.google.com/macros/s/AKfycbwR5r9Iv8uN0phVnsbZdv0QAuonDRwLvkGZ8j7_KuXoXgHYaODTpZ4hAmval9Jf-0R55Q/exec';

      // Inicialização do Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Configuração do IndexedDB
      const DBNAME = 'PolarAUD-DB';
      const STORENAME = 'auditDrafts';
      const DRAFT_KEY = 'current_audit_draft';

      async function openDb() {
        return idb.openDB(DBNAME, 1, {
          upgrade(db) {
            db.createObjectStore(STORENAME);
          },
        });
      }

      async function saveDraft(draft) {
        const db = await openDb();
        await db.put(STORENAME, draft, DRAFT_KEY);
      }

      async function loadDraft() {
        const db = await openDb();
        return db.get(STORENAME, DRAFT_KEY);
      }

      async function clearDraft() {
        const db = await openDb();
        await db.delete(STORENAME, DRAFT_KEY);
      }
      
      // Dados estáticos da aplicação
      const SECTORS = ["SESMT","CONSULTORIA", "CONFORMIDADE", "SEGURANÇA PATRIMONIAL"];
      const AUDITED_ENTITIES = ["RFB", "APPA", "MAPA", "MINISTÉRIOS DO TRABALHO", "CONPORTOS"];
      const RESPONSIBLE_SECTORS = ["T.I", "MEIO AMBIENTE", "MANUTENÇÃO MECÂNICA", "MANUTENÇÃO CIVIL", "SEGURANÇA DO TRABALHO", "ELÉTRICA", "QUALIDADE", "OPERAÇÃO"];
      const ZONES = {
        "ZONA 1": ["Estacionamento Diretoria", "Estacionamento Geral", "Subestação de Energia 1", "Sala Administrativo 1 (Contabilidade, Diretoria, Controladoria etc.)", "Sala Administrativo 2 (Cadastro, T.I, Aduaneiro)", "Sala de Recursos Humanos", "Sala de treinamento", "Guarita", "Sala de apoio", "Lava-car", "Balança (Portaria)", "Central de Resíduos", "Casa de Bombas 1", "AZ-Oficina", "Subestação de Energia 2", "AZ-01", "AZ-02", "AZ-03", "AZ-04", "AZ-17", "AZ-18", "AZ-28", "Balança (Lado AZ-28)", "Central de Fertilizantes", "Posto", "Refeitório", "Sala CCOM"],
        "ZONA 2": ["Scanner", "Atracadouro", "Marégrafo", "AZ-05", "AZ-06", "AZ-07", "AZ-11", "Castelo D’água", "Sala Oficina", "Sala Almoxarifado", "Sala SESMT", "Sala Operações", "Sala Manutenção Eletrica", "Subestação de Energia 3", "Subestação de Energia 4", "Casa de Bombas 2", "Berço de Atracação 1", "Berço de Atracação 2"],
        "ZONA 3": ["Balança (Caís)", "AZ-08", "AZ-09", "AZ-10", "AZ-12", "AZ-13", "AZ-14", "AZ-19", "AZ-23", "AZ-25", "AZ-Ensacados", "Balança (Lado Silo)", "Oficina MHC", "SILO-01", "SILO-02", "SILO-03", "SILO-04", "SILO-05", "SILO-06", "Subestação Silos", "Sala compressor", "Moega"],
        "ZONA 4": ["AZ-15", "AZ-16", "AZ-20", "AZ-21", "AZ-22", "AZ-24 (Box)", "AZ-26", "AZ-27"],
      };

      const PREDEFINED_DESCRIPTIONS = {
        "CONPORTOS": [
            "OUTROS",
            "LIMPEZA DA TELA – TODO PERÍMETRO",
            "LIMPEZA DA CONCERTINA – TODO PERÍMETRO",
            "LIMPEZA DA TELA E CONCERTINA – TODO PERÍMETRO",
            "MANUTENÇÃO DA TELA",
            "AUSÊNCIA DE CONCERTINA",
            "MANUTENÇÃO NO PORTÃO",
            "REMOÇÃO DOS MATERIAIS PRÓXIMOS À CONCERTINA",
            "MANUTENÇÃO NA CONCERTINA",
            "PODAR VEGETAÇÃO NA CONCERTINA E TELA – TODO PERÍMETRO",
            "AUSÊNCIA DE GRADE DE PROTEÇÃO",
            "MANUTENÇÃO NO CABEAMENTO – PRECISA ESTAR ENVELOPADO OU ENTERRADO",
            "FALTA DE LACRE NO QUADRO DE ENERGIA DA TI",
            "MANUTENÇÃO NA TRANCA DO QUADRO DE ENERGIA DA TI",
        ],
        "MINISTÉRIOS DO TRABALHO": [
            "OUTROS",
            "AUSÊNCIA DE ANTIDERRAPANTE",
            "AUSÊNCIA DE CAPA DE PROTEÇÃO NA LUMINÁRIA",
            "AUSÊNCIA DE PLACA DE “PARE”",
            "AUSÊNCIA DE GRADE DE PROTEÇÃO",
            "AUSÊNCIA DE ISOLAMENTO",
            "AUSÊNCIA DE PAVIMENTAÇÃO",
            "AUSÊNCIA DE TAMPA",
            "AUSÊNCIA DE TELHA",
            "AUSÊNCIA DE SALA DE BLOCO",
            "AUSÊNCIA DE GUARDA RAIL",
            "INFILTRAÇÃO",
            "AUSÊNCIA DE LIMPEZA",
            "AUSÊNCIA DE LUZ DE EMERGÊNCIA",
            "MANUTENÇÃO NOS BANCOS",
            "MANUTENÇÃO NA LUMINÁRIA",
            "AUSÊNCIA DE MANUTENÇÃO",
            "MELHORIA NA FIAÇÃO",
            "AUSÊNCIA DE PINTURA NAS FAIXAS DE PEDESTRE",
            "AUSÊNCIA DE PLACA “PROIBIDO FUMAR”",
            "AUSÊNCIA DE ROTA DE FUGA",
            "AUSÊNCIA DE PLACA DE EMERGÊNCIA",
            "RACHADURA NA PAREDE",
            "RASGO NA LONA",
            "REALOCAÇÃO DE EXTINTORES",
            "REMOÇÃO DE COLMEIA",
            "REMOÇÃO DE ESTRUTURA",
            "REMOÇÃO DE RESÍDUOS",
        ],
        "APPA": [
            "OUTROS",
            "AUSÊNCIA DE GRADE DE PROTEÇÃO",
            "AUSÊNCIA DE ISOLAMENTO",
            "AUSÊNCIA DE TAMPA",
            "LIMPEZA DA VIA",
            "MANUTENÇÃO NA GRADE",
            "MANUTENÇÃO NA IDENTIFICAÇÃO DOS RESÍDUOS",
            "MANUTENÇÃO NO BUEIRO",
            "RASGO NA LONA",
            "RESÍDUOS ESPALHADOS",
            "RESÍDUOS NA CANALETA",
        ],
        "RFB": ["OUTROS"],
        "MAPA": ["OUTROS"],
      };

      function Notification({ message, type, onClose }) {
        const [exiting, setExiting] = React.useState(false);

        const colors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            warning: 'bg-yellow-500',
            info: 'bg-blue-500',
        };

        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle',
        }

        React.useEffect(() => {
            const timer = setTimeout(() => {
                setExiting(true);
                setTimeout(onClose, 500);
            }, 5000);
            return () => clearTimeout(timer);
        }, [onClose]);

        const handleClose = () => {
            setExiting(true);
            setTimeout(onClose, 500);
        };

        return (
            <div className={`notification ${exiting ? 'notification-exit-active' : 'notification-enter-active'} flex items-center ${colors[type]} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-lg mb-2`} role="alert">
                <i className={`fas ${icons[type]} mr-3`}></i>
                <p>{message}</p>
                <button onClick={handleClose} className="ml-auto -mr-2 p-1">
                    <i className="fas fa-times"></i>
                </button>
            </div>
        );
      }

      function ConfirmationModal({ action, onCancel }) {
          if (!action) return null;

          const colorClasses = {
              green: 'bg-green-600 hover:bg-green-700',
              red: 'bg-red-600 hover:bg-red-700',
              default: 'bg-blue-600 hover:bg-blue-700'
          };

          const confirmColorClass = colorClasses[action.color] || colorClasses.default;

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                  <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                      <p className="text-center mb-4">{action.message}</p>
                      <div className="flex justify-center gap-4">
                          <button onClick={onCancel} className="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button>
                          <button onClick={action.onConfirm} className={`px-4 py-2 text-white rounded-lg ${confirmColorClass}`}>Confirmar</button>
                      </div>
                  </div>
              </div>
          );
      }

      // Componente Principal
      function App() {
        const [view, setView] = React.useState('loading');
        const [user, setUser] = React.useState(null);
        const [userData, setUserData] = React.useState(null);
        const [notifications, setNotifications] = React.useState([]);
        const [loading, setLoading] = React.useState(false);
        const [selectedAuditId, setSelectedAuditId] = React.useState(null);

        const notify = (message, type = 'info') => {
            const id = Date.now();
            setNotifications(prev => [...prev, { id, message, type }]);
        };

        const removeNotification = (id) => {
            setNotifications(prev => prev.filter(n => n.id !== id));
        };

        React.useEffect(() => {
          const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
              setUser(currentUser);
              const userDoc = await getDoc(doc(db, "users", currentUser.uid));
              if (userDoc.exists()) {
                setUserData(userDoc.data());
                setView('home');
              } else {
                setView('login');
              }
            } else {
              setUser(null);
              setUserData(null);
              setView('login');
            }
          });
          return () => unsubscribe();
        }, []);

        const handleLogout = async () => {
          await signOut(auth);
          setView('login');
        };
        
        const handleNavigate = (newView) => {
            if (newView === 'home' || newView === 'history') {
                setSelectedAuditId(null);
            }
            setView(newView);
        };

        const handleNewAudit = () => {
            setSelectedAuditId(null);
            setView('audit');
        };

        const handleContinueAudit = (auditId) => {
            setSelectedAuditId(auditId);
            setView('audit');
        };

        const handleViewAudit = (auditId) => {
            setSelectedAuditId(auditId);
            setView('viewAudit');
        };

        const renderView = () => {
          switch (view) {
            case 'loading':
              return <div className="flex justify-center items-center h-screen"><div className="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div></div>;
            case 'login':
              return <LoginPage setView={handleNavigate} notify={notify} setLoading={setLoading} />;
            case 'register':
              return <RegisterPage setView={handleNavigate} notify={notify} setLoading={setLoading} />;
            case 'forgotPassword':
              return <ForgotPasswordPage setView={handleNavigate} notify={notify} setLoading={setLoading} />;
            case 'home':
              return <HomePage userData={userData} setView={handleNavigate} handleLogout={handleLogout} handleNewAudit={handleNewAudit} />;
            case 'audit':
              return <AuditForm userData={userData} setView={handleNavigate} auditId={selectedAuditId} notify={notify} />;
            case 'history':
              return <HistoryPage userData={userData} setView={handleNavigate} onContinue={handleContinueAudit} onView={handleViewAudit} notify={notify} setLoading={setLoading} />;
            case 'account':
              return <AccountPage userData={userData} setUserData={setUserData} setView={handleNavigate} notify={notify} />;
            case 'viewAudit':
              return <ViewAuditPage userData={userData} setView={handleNavigate} auditId={selectedAuditId} notify={notify} setLoading={setLoading} />;
            default:
              return <LoginPage setView={handleNavigate} notify={notify} setLoading={setLoading} />;
          }
        };

        return (
          <div className="min-h-screen bg-gray-100">
            <div className="fixed bottom-4 right-4 z-50 w-full max-w-sm">
                {notifications.map(n => (
                    <Notification key={n.id} message={n.message} type={n.type} onClose={() => removeNotification(n.id)} />
                ))}
            </div>
            {loading && !view.includes('audit') && <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"><div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div><p className="ml-4 text-white">Processando...</p></div>}
            {renderView()}
          </div>
        );
      }
      
      function LoginPage({ setView, notify, setLoading }) {
        const [email, setEmail] = React.useState('');
        const [password, setPassword] = React.useState('');

        const handleLogin = async (e) => {
            e.preventDefault();
            if (!email || !password) {
                notify("Por favor, preencha todos os campos.", "warning");
                return;
            }
            setLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                notify("Falha no login. Verifique suas credenciais.", "error");
                console.error(err);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
                    <img src="https://i.imgur.com/TN9JSD7.png" alt="Logo da PolarAUD" className="mx-auto h-52 w-auto" />
                    <p className="text-center text-gray-500">Acesse sua conta de auditoria</p>
                    <form onSubmit={handleLogin} className="space-y-6">
                        <div>
                            <label className="text-sm font-medium text-gray-600">Email</label>
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="seu.email@exemplo.com" />
                        </div>
                        <div>
                            <label className="text-sm font-medium text-gray-600">Senha</label>
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="********" />
                        </div>
                        <div className="flex items-center justify-between">
                            <button type="button" onClick={() => setView('forgotPassword')} className="text-sm text-blue-600 hover:underline">Esqueceu a senha?</button>
                        </div>
                        <button type="submit" className="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">Entrar</button>
                    </form>
                    <p className="text-sm text-center text-gray-500">Não tem uma conta? <button onClick={() => setView('register')} className="font-medium text-blue-600 hover:underline">Registre-se</button></p>
                </div>
            </div>
        );
      }

      function ForgotPasswordPage({ setView, notify, setLoading }) {
        const [email, setEmail] = React.useState('');
        
        const handleResetPassword = async (e) => {
            e.preventDefault();
            if (!email) {
                notify("Por favor, insira seu e-mail.", "warning");
                return;
            }
            setLoading(true);
            try {
                await sendPasswordResetEmail(auth, email);
                notify("E-mail de redefinição enviado! Verifique sua caixa de entrada.", "success");
                setView('login');
            } catch (err) {
                notify("Falha ao enviar e-mail. Verifique se o e-mail está correto.", "error");
                console.error(err);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
                    <h1 className="text-2xl font-bold text-center text-gray-800">Redefinir Senha</h1>
                    <p className="text-center text-gray-500">Insira seu e-mail para receber o link de redefinição.</p>
                    <form onSubmit={handleResetPassword} className="space-y-6">
                        <div>
                            <label className="text-sm font-medium text-gray-600">Email</label>
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="seu.email@exemplo.com" required />
                        </div>
                        <button type="submit" className="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">Enviar E-mail</button>
                    </form>
                    <p className="text-sm text-center text-gray-500">
                        <button onClick={() => setView('login')} className="font-medium text-blue-600 hover:underline">Voltar para o Login</button>
                    </p>
                </div>
            </div>
        );
      }

      function RegisterPage({ setView, notify, setLoading }) {
        const [secret, setSecret] = React.useState('');
        const [isSecretValid, setIsSecretValid] = React.useState(false);
        const [formData, setFormData] = React.useState({
            username: '',
            fullName: '',
            email: '',
            password: '',
            sector: SECTORS[0]
        });
        const SECRET_KEY = "@PolarAud@";

        const handleSecretCheck = () => {
            if (secret === SECRET_KEY) {
                setIsSecretValid(true);
            } else {
                notify("Segredo incorreto!", "error");
            }
        };

        const handleChange = (e) => {
            setFormData({ ...formData, [e.target.name]: e.target.value });
        };
        
        const handleRegister = async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, formData.email, formData.password);
                const user = userCredential.user;
                
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    username: formData.username,
                    fullName: formData.fullName,
                    email: formData.email,
                    sector: formData.sector,
                    role: 'auditor'
                });
                notify("Usuário registrado com sucesso!", "success");
            } catch (err) {
                notify("Falha no registro: " + err.message, "error");
                console.error(err);
            } finally {
                setLoading(false);
            }
        };

        if (!isSecretValid) {
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-50">
                    <div className="w-full max-w-sm p-8 space-y-4 bg-white rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold text-center text-gray-800">Acesso ao Registro</h2>
                        <p className="text-center text-gray-500">Insira o segredo para continuar.</p>
                        <input type="password" value={secret} onChange={e => setSecret(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Segredo de acesso" />
                        <button onClick={handleSecretCheck} className="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Verificar</button>
                        <button onClick={() => setView('login')} className="w-full mt-2 text-center text-blue-600 hover:underline">Voltar para o Login</button>
                    </div>
                </div>
            );
        }

        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50 py-12">
                <div className="w-full max-w-lg p-8 space-y-6 bg-white rounded-xl shadow-lg">
                    <h1 className="text-3xl font-bold text-center text-gray-800">Registro de Novo Usuário</h1>
                    <form onSubmit={handleRegister} className="space-y-4">
                        <input name="username" onChange={handleChange} placeholder="Nome de usuário" className="w-full px-4 py-2 bg-gray-100 border rounded-lg" required />
                        <input name="fullName" onChange={handleChange} placeholder="Nome Completo" className="w-full px-4 py-2 bg-gray-100 border rounded-lg" required />
                        <input name="email" type="email" onChange={handleChange} placeholder="E-mail" className="w-full px-4 py-2 bg-gray-100 border rounded-lg" required />
                        <input name="password" type="password" onChange={handleChange} placeholder="Senha (mínimo 6 caracteres)" className="w-full px-4 py-2 bg-gray-100 border rounded-lg" required />
                        <select name="sector" onChange={handleChange} className="w-full px-4 py-2 bg-gray-100 border rounded-lg">
                            {SECTORS.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                        <button type="submit" className="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Registrar</button>
                    </form>
                     <button onClick={() => setView('login')} className="w-full mt-2 text-center text-blue-600 hover:underline">Já tenho uma conta</button>
                </div>
            </div>
        );
      }

      function AccountPage({ userData, setUserData, setView, notify }) {
        const [fullName, setFullName] = React.useState(userData.fullName);
        const [sector, setSector] = React.useState(userData.sector);
        const [isSaving, setIsSaving] = React.useState(false);

        const handleSave = async () => {
            setIsSaving(true);
            try {
                const userRef = doc(db, "users", userData.uid);
                await updateDoc(userRef, {
                    fullName: fullName,
                    sector: sector
                });
                setUserData({ ...userData, fullName, sector });
                notify('Dados atualizados com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao atualizar dados:", error);
                notify('Falha ao atualizar dados.', 'error');
            } finally {
                setIsSaving(false);
            }
        };

        return (
            <div className="p-4 md:p-8 max-w-2xl mx-auto">
                <header className="flex justify-between items-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-800">Minha Conta</h1>
                    <button onClick={() => setView('home')} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg shadow-sm hover:bg-gray-50">Voltar</button>
                </header>
                <div className="bg-white p-8 rounded-xl shadow-lg space-y-6">
                    <div>
                        <label className="text-sm font-medium text-gray-600">Nome Completo</label>
                        <input type="text" value={fullName} onChange={e => setFullName(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                     <div>
                        <label className="text-sm font-medium text-gray-600">Email</label>
                        <input type="email" value={userData.email} className="w-full px-4 py-2 mt-2 text-base text-gray-500 bg-gray-200 border rounded-lg" disabled />
                    </div>
                    <div>
                        <label className="text-sm font-medium text-gray-600">Setor</label>
                        <select value={sector} onChange={e => setSector(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {SECTORS.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                    </div>
                    <div className="flex justify-end items-center">
                        <button onClick={handleSave} disabled={isSaving} className="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                            {isSaving ? 'Salvando...' : 'Salvar Alterações'}
                        </button>
                    </div>
                </div>
            </div>
        );
      }
      
      function HomePage({ userData, setView, handleLogout, handleNewAudit }) {
        const [showMenu, setShowMenu] = React.useState(false);
        return (
            <div className="p-4 md:p-8">
                <header className="flex justify-between items-center mb-8">
                    <img src="https://i.imgur.com/TN9JSD7.png" alt="Logo da PolarAUD" className="h-24 w-auto" />
                    <div className="relative">
                        <button onClick={() => setShowMenu(!showMenu)} className="flex items-center space-x-2 p-2 rounded-full bg-white shadow">
                            <span className="font-medium text-gray-700 hidden md:block">{userData?.fullName}</span>
                            <i className="fas fa-user-circle text-2xl text-gray-500"></i>
                        </button>
                        {showMenu && (
                            <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                                <button onClick={() => { setView('account'); setShowMenu(false); }} className="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ver/Editar Conta</button>
                                <button onClick={handleLogout} className="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sair</button>
                            </div>
                        )}
                    </div>
                </header>
                <main className="bg-white p-6 rounded-xl shadow-lg">
                    <h2 className="text-xl font-semibold text-gray-700">Bem-vindo(a), {userData?.fullName}!</h2>
                    <p className="text-gray-500 mb-8">Setor: {userData?.sector}</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onClick={handleNewAudit} className="flex flex-col items-center justify-center p-8 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
                            <i className="fas fa-plus-circle text-4xl mb-2"></i>
                            <span className="text-lg font-semibold">Iniciar Nova Auditoria</span>
                        </button>
                        <button onClick={() => setView('history')} className="flex flex-col items-center justify-center p-8 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-transform transform hover:scale-105">
                            <i className="fas fa-history text-4xl mb-2"></i>
                            <span className="text-lg font-semibold">Histórico de Auditorias</span>
                        </button>
                    </div>
                </main>
            </div>
        );
      }

      function AuditForm({ userData, setView, auditId, notify }) {
        const [auditTitle, setAuditTitle] = React.useState('');
        const [entries, setEntries] = React.useState([]);
        const [isSaving, setIsSaving] = React.useState(false);
        const [loadingMessage, setLoadingMessage] = React.useState('');
        const [confirmAction, setConfirmAction] = React.useState(null);

        const loadingMessages = [
            "Estamos salvando sua auditoria...",
            "Aguarde...",
            "Salvando evidências...",
            "Pode demorar um pouco...",
            "Garanta uma conexão estável durante o salvamento"
        ];

        React.useEffect(() => {
            let interval;
            if (isSaving) {
                setLoadingMessage(loadingMessages[0]);
                interval = setInterval(() => {
                    setLoadingMessage(prev => {
                        const currentIndex = loadingMessages.indexOf(prev);
                        const nextIndex = (currentIndex + 1) % loadingMessages.length;
                        return loadingMessages[nextIndex];
                    });
                }, 3000);
            }
            return () => clearInterval(interval);
        }, [isSaving]);

        const base64ToFile = (base64, filename, mimeType) => {
            const byteCharacters = atob(base64.split(',')[1]);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new File([byteArray], filename, { type: mimeType });
        };

        React.useEffect(() => {
            const loadInitialData = async () => {
                if (auditId) { // MODO CONTINUAR
                    setIsSaving(true);
                    try {
                        const auditDoc = await getDoc(doc(db, "audits", auditId));
                        if (auditDoc.exists()) {
                            setAuditTitle(auditDoc.data().title || '');
                        }

                        const entriesQuery = query(collection(db, "audits", auditId, "entries"));
                        const entriesSnapshot = await getDocs(entriesQuery);
                        const fetchedEntries = entriesSnapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
                        fetchedEntries.sort((a, b) => a.entryNumber - b.entryNumber);

                        const reconstructedEntries = fetchedEntries.map(entry => {
                            const predefinedOptions = PREDEFINED_DESCRIPTIONS[entry.auditedEntity] || ["OUTROS"];
                            const isPredefined = predefinedOptions.includes(entry.description);
                            
                            return {
                                ...entry,
                                id: entry.firestoreId,
                                clientTimestamp: entry.entryTimestamp?.toDate(),
                                descriptionSelection: isPredefined ? entry.description : "OUTROS",
                                manualDescription: isPredefined ? "" : entry.description,
                                evidences: entry.evidenceUrls ? Object.entries(entry.evidenceUrls).map(([key, fileId]) => ({
                                    type: 'remote',
                                    key,
                                    fileId: fileId,
                                    preview: `https://drive.google.com/thumbnail?id=${fileId}&sz=s220`
                                })) : []
                            }
                        });
                        setEntries(reconstructedEntries);
                    } catch (error) {
                        notify("Erro ao carregar auditoria: " + error.message, 'error');
                    } finally {
                        setIsSaving(false);
                    }
                } else { // MODO NOVA AUDITORIA
                    const draft = await loadDraft();
                    if (draft) {
                         setAuditTitle(draft.title || '');
                         if (draft.entries && draft.entries.length > 0) {
                            const restoredEntries = draft.entries.map(entry => ({
                                ...entry,
                                clientTimestamp: entry.clientTimestamp ? new Date(entry.clientTimestamp) : new Date(),
                                evidences: entry.evidences.map(ev => ({
                                    ...ev, 
                                    type: 'local',
                                    file: base64ToFile(ev.base64, ev.file.name, ev.file.type),
                                    preview: URL.createObjectURL(base64ToFile(ev.base64, ev.file.name, ev.file.type))
                                }))
                            }));
                            setEntries(restoredEntries);
                        } else {
                            addEntry();
                        }
                    } else {
                        addEntry();
                    }
                }
            };
            loadInitialData();
        }, [auditId]);
        
        React.useEffect(() => {
            if (!auditId) { // Only save drafts for new audits
                const draftToSave = {
                    title: auditTitle,
                    entries: entries.map(entry => ({
                        ...entry,
                        clientTimestamp: entry.clientTimestamp.toISOString(),
                        evidences: entry.evidences.filter(ev => ev.type === 'local').map(ev => ({
                            base64: ev.base64, 
                            file: {name: ev.file.name, type: ev.file.type}
                        }))
                    }))
                };
                saveDraft(draftToSave);
            }
        }, [entries, auditTitle, auditId]);

        const addEntry = () => {
             const newEntryData = {
                id: Date.now(),
                entryNumber: entries.length + 1,
                description: '',
                descriptionSelection: PREDEFINED_DESCRIPTIONS[AUDITED_ENTITIES[0]][0] || 'OUTROS',
                manualDescription: '',
                complement: '',
                responsibleSector: RESPONSIBLE_SECTORS[0],
                evidences: [],
                clientTimestamp: new Date()
            };

            if (entries.length > 0) {
                const lastEntry = entries[entries.length - 1];
                newEntryData.auditedEntity = lastEntry.auditedEntity;
                newEntryData.operationalZone = lastEntry.operationalZone;
                newEntryData.location = lastEntry.location;
                newEntryData.responsibleSector = lastEntry.responsibleSector;
                newEntryData.descriptionSelection = PREDEFINED_DESCRIPTIONS[lastEntry.auditedEntity][0] || 'OUTROS';
            } else {
                newEntryData.auditedEntity = AUDITED_ENTITIES[0];
                newEntryData.operationalZone = Object.keys(ZONES)[0];
                newEntryData.location = ZONES[Object.keys(ZONES)[0]][0];
            }
            setEntries([...entries, newEntryData]);
        };

        const removeEntry = (indexToRemove) => {
            setConfirmAction({
                message: "Tem certeza que deseja apagar este apontamento?",
                color: "red",
                onConfirm: () => {
                    const newEntries = entries.filter((_, index) => index !== indexToRemove);
                    const renumberedEntries = newEntries.map((entry, index) => ({
                        ...entry,
                        entryNumber: index + 1
                    }));
                    setEntries(renumberedEntries);
                    setConfirmAction(null);
                }
            });
        };

        const updateEntry = (index, field, value) => {
            const newEntries = [...entries];
            const entry = newEntries[index];
            entry[field] = value;

            if (field === 'auditedEntity') {
                entry.location = ZONES[entry.operationalZone][0];
                const newOptions = PREDEFINED_DESCRIPTIONS[value] || ["OUTROS"];
                entry.descriptionSelection = newOptions[0];
                entry.manualDescription = '';
            }
            
            if (field === 'operationalZone') {
                entry.location = ZONES[value][0];
            }

            if (field === 'descriptionSelection' && value !== 'OUTROS') {
                entry.manualDescription = '';
            }

            setEntries(newEntries);
        };

        const handleTitleChange = (e) => {
            const value = e.target.value;
            const formattedTitle = value.replace(/\b\w/g, char => char.toUpperCase());
            setAuditTitle(formattedTitle);
        };

        const handleImageChange = async (index, event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const currentEvidences = entries[index].evidences;
            if (currentEvidences.length + files.length > 3) {
                notify("Você pode adicionar no máximo 3 evidências.", "warning");
                return;
            }

            const options = {
                maxSizeMB: 0.8,
                maxWidthOrHeight: 1024,
                useWebWorker: true
            };

            for (const file of files) {
                try {
                    const compressedFile = await imageCompression(file, options);
                    const reader = new FileReader();
                    reader.readAsDataURL(compressedFile);
                    reader.onloadend = () => {
                        const base64String = reader.result;
                        const newEvidence = {
                            type: 'local',
                            file: compressedFile,
                            base64: base64String,
                            preview: URL.createObjectURL(compressedFile)
                        };
                        
                        const newEntries = [...entries];
                        newEntries[index].evidences.push(newEvidence);
                        setEntries(newEntries);
                    };
                } catch (error) {
                    console.error("Erro na compressão:", error);
                    notify("Falha ao processar a imagem.", "error");
                }
            }
        };

        const removeEvidence = (entryIndex, evidenceIndex) => {
            const newEntries = [...entries];
            const evidenceToRemove = newEntries[entryIndex].evidences[evidenceIndex];
            if (evidenceToRemove.type === 'local') {
                URL.revokeObjectURL(evidenceToRemove.preview);
            }
            newEntries[entryIndex].evidences.splice(evidenceIndex, 1);
            setEntries(newEntries);
        };
        
        const getTimestampString = () => {
            const d = new Date();
            const pad = (n) => n.toString().padStart(2, '0');
            return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
        };

        const saveAudit = async () => {
            if (!auditTitle.trim()) {
                 notify("Por favor, insira um título para a auditoria.", "warning");
                 return;
            }
            
            for (const entry of entries) {
                const finalDescription = entry.descriptionSelection === 'OUTROS' ? entry.manualDescription : entry.descriptionSelection;
                if (!finalDescription || !entry.responsibleSector) {
                     notify("Cada apontamento deve ter uma descrição e um setor responsável.", "warning");
                     return;
                }
            }

            setIsSaving(true);

            try {
                const allEvidencePromises = entries.map(async (entry) => {
                    const localImagesToUpload = entry.evidences.filter(ev => ev.type === 'local');
                    const remoteImagesToKeep = entry.evidences.filter(ev => ev.type === 'remote');
                    const finalEvidenceUrls = {};
                    remoteImagesToKeep.forEach(ev => { finalEvidenceUrls[ev.key] = ev.fileId; });

                    if (localImagesToUpload.length > 0) {
                        const imagePayload = localImagesToUpload.map((ev, localIndex) => {
                            const timestamp = getTimestampString();
                            const safeEntity = entry.auditedEntity.replace(/[^a-zA-Z0-9]/g, '');
                            const safeZone = entry.operationalZone.replace(/[^a-zA-Z0-9]/g, '');
                            const evidenceNumber = remoteImagesToKeep.length + localIndex + 1;
                            const fileName = `AUD_${safeEntity}_${safeZone}_AP${entry.entryNumber}_EV${evidenceNumber}_${timestamp}`;
                            return { base64: ev.base64.split(',')[1], mimeType: ev.file.type, fileName: fileName };
                        });

                        const response = await fetch(IMAGE_API_URL, {
                            method: 'POST',
                            headers: {'Content-Type': 'text/plain;charset=utf-8'},
                            body: JSON.stringify({ images: imagePayload }),
                        });

                        if (!response.ok) throw new Error(`API de imagens retornou: ${response.statusText}`);
                        const result = await response.json();
                        if (result.status !== 'success') throw new Error(`API de imagens falhou: ${result.message} ${result.stack || ''}`);
                        
                        result.files.forEach(fileInfo => { finalEvidenceUrls[fileInfo.key] = fileInfo.id; });
                    }
                    return { ...entry, evidenceUrls: finalEvidenceUrls };
                });

                const entriesWithUrls = await Promise.all(allEvidencePromises);

                const batch = writeBatch(db);
                let currentAuditId = auditId;

                const auditData = {
                    userId: userData.uid,
                    userFullName: userData.fullName,
                    title: auditTitle,
                    status: "pending",
                    firstEntrySummary: {
                        auditedEntity: entries[0].auditedEntity,
                        operationalZone: entries[0].operationalZone
                    },
                    entryCount: entries.length
                };

                if (!currentAuditId) {
                    const auditRef = doc(collection(db, "audits"));
                    currentAuditId = auditRef.id;
                    auditData.createdAt = serverTimestamp();
                    batch.set(auditRef, auditData);
                } else {
                    const auditRef = doc(db, "audits", currentAuditId);
                    batch.update(auditRef, auditData);
                    const oldEntriesSnapshot = await getDocs(collection(db, "audits", currentAuditId, "entries"));
                    oldEntriesSnapshot.forEach(doc => batch.delete(doc.ref));
                }

                entriesWithUrls.forEach((entry) => {
                    const entryRef = doc(collection(db, "audits", currentAuditId, "entries"));
                    const { evidences, id, clientTimestamp, descriptionSelection, manualDescription, ...entryToSave } = entry;
                    
                    const finalDescription = descriptionSelection === 'OUTROS' ? manualDescription : descriptionSelection;

                    batch.set(entryRef, {
                        ...entryToSave,
                        description: finalDescription,
                        userId: userData.uid,
                        technicalSector: userData.sector,
                        entryTimestamp: clientTimestamp
                    });
                });
                
                await batch.commit();
                await clearDraft();
                notify("Auditoria salva com sucesso!", "success");
                setView('home');

            } catch (error) {
                console.error("Erro ao salvar auditoria:", error);
                notify("Ocorreu um erro grave ao salvar. Detalhes: " + error.message, "error");
            } finally {
                setIsSaving(false);
            }
        };

        return (
            <>
            {isSaving && (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex flex-col justify-center items-center z-50">
                    <div className="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32 mb-4"></div>
                    <p className="text-white text-xl">{loadingMessage}</p>
                </div>
            )}
            <ConfirmationModal action={confirmAction} onCancel={() => setConfirmAction(null)} />
            <div className={`p-4 md:p-8 max-w-4xl mx-auto ${isSaving ? 'pointer-events-none' : ''}`}>
                <header className="flex justify-between items-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-800">{auditId ? 'Continuar Auditoria' : 'Nova Auditoria'}</h1>
                    <button onClick={() => setView('home')} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg shadow-sm hover:bg-gray-50">Voltar</button>
                </header>
                
                <div className="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <label htmlFor="auditTitle" className="block text-sm font-medium text-gray-700 mb-1">Título da Auditoria</label>
                    <input 
                        id="auditTitle"
                        type="text"
                        value={auditTitle}
                        onChange={handleTitleChange}
                        placeholder="Ex: Auditoria Semanal de Segurança"
                        className="w-full p-2 bg-gray-50 border rounded-md"
                        required
                    />
                </div>

                <div className="space-y-6">
                    {entries.map((entry, index) => (
                        <div key={entry.id || index} className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 relative">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-semibold text-gray-700">Apontamento #{entry.entryNumber}</h3>
                                <button onClick={() => removeEntry(index)} className="text-red-500 hover:text-red-700">
                                    <i className="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Órgão Anuente Auditado</label>
                                    <select value={entry.auditedEntity} onChange={e => updateEntry(index, 'auditedEntity', e.target.value)} className="w-full p-2 bg-gray-50 border rounded-md">
                                        {AUDITED_ENTITIES.map(e => <option key={e} value={e}>{e}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Setor Responsável</label>
                                    <select value={entry.responsibleSector} onChange={e => updateEntry(index, 'responsibleSector', e.target.value)} className="w-full p-2 bg-gray-50 border rounded-md" required>
                                        {RESPONSIBLE_SECTORS.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Zona Operacional</label>
                                    <select value={entry.operationalZone} onChange={e => updateEntry(index, 'operationalZone', e.target.value)} className="w-full p-2 bg-gray-50 border rounded-md">
                                        {Object.keys(ZONES).map(z => <option key={z} value={z}>{z}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Local</label>
                                    <select value={entry.location} onChange={e => updateEntry(index, 'location', e.target.value)} className="w-full p-2 bg-gray-50 border rounded-md">
                                        {ZONES[entry.operationalZone].map(l => <option key={l} value={l}>{l}</option>)}
                                    </select>
                                </div>
                                
                                <div className="md:col-span-2 space-y-2">
                                    <label className="block text-sm font-medium text-gray-700">Apontamento</label>
                                    <select 
                                        value={entry.descriptionSelection} 
                                        onChange={e => updateEntry(index, 'descriptionSelection', e.target.value)} 
                                        className="w-full p-2 bg-gray-50 border rounded-md"
                                    >
                                        {(PREDEFINED_DESCRIPTIONS[entry.auditedEntity] || ["OUTROS"]).map(desc => (
                                            <option key={desc} value={desc}>{desc}</option>
                                        ))}
                                    </select>

                                    {entry.descriptionSelection === 'OUTROS' && (
                                        <textarea 
                                            value={entry.manualDescription} 
                                            onChange={e => updateEntry(index, 'manualDescription', e.target.value)} 
                                            placeholder="Descreva o apontamento (EM MAIÚSCULAS)" 
                                            className="w-full p-2 bg-gray-50 border rounded-md h-24 uppercase" 
                                            required 
                                        />
                                    )}
                                </div>

                                <textarea value={entry.complement} onChange={e => updateEntry(index, 'complement', e.target.value)} placeholder="Complemento (opcional)" className="w-full p-2 bg-gray-50 border rounded-md md:col-span-2 h-20"></textarea>
                                
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Evidências (até 3 imagens)</label>
                                    <input type="file" accept="image/*" multiple onChange={(e) => handleImageChange(index, e)} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                    <div className="mt-4 flex flex-wrap gap-4">
                                        {entry.evidences.map((ev, evIndex) => (
                                            <div key={ev.preview || evIndex} className="relative">
                                                <img src={ev.preview} className="w-24 h-24 object-cover rounded-lg shadow" />
                                                <button onClick={() => removeEvidence(index, evIndex)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">&times;</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="mt-8 flex flex-col md:flex-row justify-between items-center gap-4">
                    <button onClick={addEntry} className="w-full md:w-auto px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                        <i className="fas fa-plus mr-2"></i> Adicionar Novo Apontamento
                    </button>
                    <button onClick={saveAudit} disabled={isSaving} className="w-full md:w-auto px-8 py-4 bg-blue-700 text-white font-bold rounded-lg hover:bg-blue-800 disabled:bg-gray-400 transition-colors text-lg">
                        {isSaving ? 'Salvando...' : 'Salvar Auditoria Completa'}
                    </button>
                </div>
            </div>
            </>
        );
      }
      
      function HistoryPage({ userData, setView, onContinue, onView, notify, setLoading }) {
        const [audits, setAudits] = React.useState([]);
        const [loadingData, setLoadingData] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [filter, setFilter] = React.useState('');
        const [showExportModal, setShowExportModal] = React.useState(false);
        const [selectedAuditIds, setSelectedAuditIds] = React.useState([]);
        const [startDate, setStartDate] = React.useState('');
        const [endDate, setEndDate] = React.useState('');
        const [confirmAction, setConfirmAction] = React.useState(null);

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return null;
            // Can be a Firestore Timestamp or a JS Date object
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const fetchAudits = async () => {
            if (!userData) {
                setLoadingData(false);
                return;
            }
            setLoadingData(true);
            setError(null);
            try {
                const q = userData.role === 'admin' 
                    ? query(collection(db, "audits"))
                    : query(collection(db, "audits"), where("userId", "==", userData.uid));
                
                const querySnapshot = await getDocs(q);
                const auditsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                auditsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                setAudits(auditsData);
            } catch (err) {
                console.error("Erro ao buscar auditorias:", err);
                setError("Não foi possível carregar o histórico. Tente novamente mais tarde.");
            } finally {
                setLoadingData(false);
            }
        };

        React.useEffect(() => {
            fetchAudits();
        }, [userData]);
        
        const handleStatusChange = async (auditId, newStatus) => {
            setConfirmAction({
                message: "Tem certeza que deseja concluir essa auditoria?",
                color: 'green',
                onConfirm: async () => {
                    const auditRef = doc(db, "audits", auditId);
                    // Bug Fix: Only update status and completedAt, never createdAt
                    await updateDoc(auditRef, { 
                        status: newStatus,
                        completedAt: serverTimestamp()
                    });
                    fetchAudits();
                    setConfirmAction(null);
                    notify("Status da auditoria alterado com sucesso!", "success");
                }
            });
        };

        const handleDeleteAudit = async (auditId) => {
            setConfirmAction({
                message: "Tem certeza que deseja apagar esta auditoria permanentemente? Esta ação não pode ser desfeita.",
                color: 'red',
                onConfirm: async () => {
                    setLoading(true);
                    setConfirmAction(null);
                    try {
                        const entriesRef = collection(db, "audits", auditId, "entries");
                        const entriesSnapshot = await getDocs(entriesRef);
                        
                        const batch = writeBatch(db);
                        
                        entriesSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        batch.delete(doc(db, "audits", auditId));
                        
                        await batch.commit();

                        notify("Auditoria apagada com sucesso!", "success");
                        fetchAudits();
                    } catch (err) {
                        console.error("Erro ao apagar auditoria:", err);
                        notify("Falha ao apagar a auditoria. Verifique as permissões e tente novamente.", "error");
                    } finally {
                        setLoading(false);
                    }
                }
            });
        };
        
        const handleExportClick = () => {
            setShowExportModal(true);
        };

        const handleAuditSelectionChange = (auditId) => {
            setSelectedAuditIds(prev => 
                prev.includes(auditId) ? prev.filter(id => id !== auditId) : [...prev, auditId]
            );
        };

        const handleFinalExport = () => {
             if (selectedAuditIds.length === 0) {
                notify("Nenhuma auditoria selecionada para exportar.", "warning");
                return;
            }
            exportToCSV(selectedAuditIds);
            setShowExportModal(false);
            setSelectedAuditIds([]);
        };

        const exportToCSV = async (auditIdsToExport) => {
            setLoading(true);
            let entriesToExport = [];
            let fileName = 'relatorio_polaraud.csv';
            
            if (!auditIdsToExport || auditIdsToExport.length === 0) {
                notify("Nenhuma auditoria para exportar.", "warning");
                setLoading(false);
                return;
            }

            if (auditIdsToExport.length === 1) {
                fileName = `auditoria_${auditIdsToExport[0]}.csv`;
            } else {
                fileName = `auditorias_selecionadas.csv`;
            }

            try {
                const auditsToProcessQuery = query(collection(db, "audits"), where("__name__", "in", auditIdsToExport));
                const auditsSnapshot = await getDocs(auditsToProcessQuery);
                const auditsToProcess = auditsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                for (const audit of auditsToProcess) {
                    const entriesSnapshot = await getDocs(collection(db, "audits", audit.id, "entries"));
                    entriesSnapshot.forEach(entryDoc => {
                        entriesToExport.push({ 
                            ...entryDoc.data(), 
                            userFullName: audit.userFullName,
                            auditTitle: audit.title
                        });
                    });
                }

                if (entriesToExport.length === 0) {
                    notify("Nenhum apontamento encontrado para exportar.", "warning");
                    setLoading(false);
                    return;
                }

                const headers = "Titulo_Auditoria,Numero_Apontamento,Auditor,Data_Hora_Apontamento,Zona_Operacional,Setor_Tecnico,Setor_Responsavel,Orgao_Anuente_Auditado,Local,Descricao_Apontamento,Complemento,Evidencia_1,Evidencia_2,Evidencia_3";
                const csvRows = [headers];

                entriesToExport.sort((a, b) => a.entryNumber - b.entryNumber).forEach(entry => {
                    const evidenceUrls = Object.values(entry.evidenceUrls || {});
                    const row = [
                        `"${entry.auditTitle || ''}"`,
                        entry.entryNumber,
                        `"${entry.userFullName || ''}"`,
                        `"${formatTimestamp(entry.entryTimestamp) || 'N/A'}"`,
                        `"${entry.operationalZone || ''}"`,
                        `"${entry.technicalSector || ''}"`,
                        `"${entry.responsibleSector || ''}"`,
                        `"${entry.auditedEntity || ''}"`,
                        `"${entry.location || ''}"`,
                        `"${(entry.description || '').replace(/"/g, '""')}"`,
                        `"${(entry.complement || '').replace(/"/g, '""')}"`,
                        // New image URL format
                        evidenceUrls[0] ? `https://drive.google.com/uc?id=${evidenceUrls[0]}` : '',
                        evidenceUrls[1] ? `https://drive.google.com/uc?id=${evidenceUrls[1]}` : '',
                        evidenceUrls[2] ? `https://drive.google.com/uc?id=${evidenceUrls[2]}` : '',
                    ];
                    csvRows.push(row.join(','));
                });

                const csvString = csvRows.join('\n');
                const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch(err) {
                 console.error("Erro ao exportar CSV:", err);
                 notify("Falha ao exportar CSV.", "error");
            } finally {
                setLoading(false);
            }
        };

        const filteredAudits = audits.filter(audit => {
            const auditDate = audit.createdAt?.seconds ? new Date(audit.createdAt.seconds * 1000) : null;
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            
            if(start) start.setHours(0,0,0,0);
            if(end) end.setHours(23,59,59,999);

            const dateMatch = (!start || (auditDate && auditDate >= start)) && (!end || (auditDate && auditDate <= end));
            
            const filterText = filter.toLowerCase();
            const textMatch = (audit.title && audit.title.toLowerCase().includes(filterText)) ||
                              (audit.userFullName && audit.userFullName.toLowerCase().includes(filterText)) ||
                              (audit.id && audit.id.toLowerCase().includes(filterText));

            return dateMatch && textMatch;
        });

        return (
            <div className="p-4 md:p-8 max-w-7xl mx-auto">
                <ConfirmationModal action={confirmAction} onCancel={() => setConfirmAction(null)} />
                <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h1 className="text-2xl font-bold text-gray-800">Histórico de Auditorias</h1>
                    <div className="flex gap-4">
                        <button onClick={() => setView('home')} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg shadow-sm hover:bg-gray-50">Voltar</button>
                        <button onClick={handleExportClick} className="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg shadow-sm hover:bg-green-700">
                            <i className="fas fa-file-csv mr-2"></i> Exportação Personalizada
                        </button>
                    </div>
                </header>
                
                {showExportModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                        <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                            <h3 className="text-lg font-bold mb-4">Exportação Personalizada</h3>
                            <p className="mb-4 text-sm text-gray-600">Selecione as auditorias que deseja incluir no relatório. Use os filtros para refinar a busca.</p>
                            <div className="flex justify-end gap-4 mt-6">
                                <button onClick={handleFinalExport} disabled={selectedAuditIds.length === 0} className="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-gray-400">Exportar {selectedAuditIds.length} Selecionada(s)</button>
                                <button onClick={() => setShowExportModal(false)} className="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                            </div>
                        </div>
                    </div>
                )}


                <div className="mb-6 bg-white p-4 rounded-lg shadow">
                    <h3 className="font-semibold mb-2">Filtros</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" placeholder="Filtrar por título, auditor ou ID..." value={filter} onChange={e => setFilter(e.target.value)} className="w-full p-2 border rounded-lg" />
                        <div>
                            <label className="text-xs text-gray-500">Data de Início</label>
                            <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full p-2 border rounded-lg" />
                        </div>
                        <div>
                            <label className="text-xs text-gray-500">Data de Fim</label>
                            <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="w-full p-2 border rounded-lg" />
                        </div>
                    </div>
                </div>

                {loadingData ? <div className="text-center p-10">Carregando histórico...</div> : error ? <div className="text-center p-10 text-red-500">{error}</div> : (
                    <div className="space-y-4">
                        {/* Mobile View */}
                        <div className="md:hidden space-y-4">
                            {filteredAudits.length > 0 ? filteredAudits.map(audit => (
                                <div key={audit.id} className="bg-white p-4 rounded-lg shadow space-y-3">
                                    <div className="flex items-center gap-3">
                                        <input 
                                            type="checkbox" 
                                            className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                            checked={selectedAuditIds.includes(audit.id)}
                                            onChange={() => handleAuditSelectionChange(audit.id)}
                                        />
                                        <div>
                                            <div className="font-bold text-gray-800">{audit.title}</div>
                                            <div className="font-mono text-xs text-gray-500 break-all">{audit.id}</div>
                                            {userData.role === 'admin' && <div className="text-sm text-gray-700">{audit.userFullName}</div>}
                                        </div>
                                    </div>
                                    <div className="text-xs text-gray-600 mt-1">Apontamentos: {audit.entryCount || 0}</div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <div className="text-xs text-gray-500">Hora de Início</div>
                                            <div className="text-sm text-gray-900">{formatTimestamp(audit.createdAt) || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500">Hora de Conclusão</div>
                                            <div className="text-sm text-gray-900">{audit.completedAt ? formatTimestamp(audit.completedAt) : 'Em andamento'}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500">Status</div>
                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${audit.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                            {audit.status === 'pending' ? 'Pendente' : 'Concluída'}
                                        </span>
                                    </div>
                                    <div className="flex justify-end items-center gap-2 pt-2 border-t">
                                        {audit.status === 'pending' ? (
                                            <>
                                                <button onClick={() => onContinue(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-blue-800 bg-blue-100 hover:bg-blue-200">Continuar</button>
                                                {(userData.role === 'admin' || userData.uid === audit.userId) && (
                                                    <button onClick={() => handleStatusChange(audit.id, 'completed')} className="px-3 py-1 text-xs font-medium rounded-md text-green-800 bg-green-100 hover:bg-green-200">Concluir</button>
                                                )}
                                            </>
                                        ) : (
                                            <button onClick={() => onView(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-indigo-800 bg-indigo-100 hover:bg-indigo-200">Visualizar</button>
                                        )}
                                        {(userData.role === 'admin' || (audit.userId === userData.uid && audit.status === 'pending')) && (
                                            <button onClick={() => handleDeleteAudit(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-red-800 bg-red-100 hover:bg-red-200">Apagar</button>
                                        )}
                                        <button onClick={() => exportToCSV([audit.id])} className="px-3 py-1 text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200">CSV</button>
                                    </div>
                                </div>
                            )) : <div className="text-center py-10 text-gray-500">Nenhuma auditoria encontrada com os filtros atuais.</div>}
                        </div>
                        
                        {/* Desktop View */}
                        <div className="hidden md:block bg-white rounded-xl shadow-lg overflow-hidden">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3"></th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Título / ID / Auditor</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Apontamentos</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora de Início</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora de Conclusão</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredAudits.length > 0 ? filteredAudits.map(audit => (
                                        <tr key={audit.id}>
                                            <td className="px-6 py-4">
                                                <input 
                                                    type="checkbox" 
                                                    className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                    checked={selectedAuditIds.includes(audit.id)}
                                                    onChange={() => handleAuditSelectionChange(audit.id)}
                                                />
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                <div className="font-bold text-gray-900">{audit.title}</div>
                                                <div className="font-mono text-gray-600 text-xs">{audit.id}</div>
                                                {userData.role === 'admin' && <div className="text-xs text-gray-500 mt-1">{audit.userFullName}</div>}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div className="text-sm text-gray-900">{audit.entryCount || 0}</div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatTimestamp(audit.createdAt) || 'N/A'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{audit.completedAt ? formatTimestamp(audit.completedAt) : 'Em andamento'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${audit.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                                {audit.status === 'pending' ? 'Pendente' : 'Concluída'}
                                            </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <div className="flex justify-end items-center gap-2">
                                                    {audit.status === 'pending' ? (
                                                        <>
                                                            <button onClick={() => onContinue(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-blue-800 bg-blue-100 hover:bg-blue-200">Continuar</button>
                                                            {(userData.role === 'admin' || userData.uid === audit.userId) && (
                                                                <button onClick={() => handleStatusChange(audit.id, 'completed')} className="px-3 py-1 text-xs font-medium rounded-md text-green-800 bg-green-100 hover:bg-green-200">Concluir</button>
                                                            )}
                                                        </>
                                                    ) : (
                                                        <button onClick={() => onView(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-indigo-800 bg-indigo-100 hover:bg-indigo-200">Visualizar</button>
                                                    )}
                                                     {(userData.role === 'admin' || (audit.userId === userData.uid && audit.status === 'pending')) && (
                                                        <button onClick={() => handleDeleteAudit(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-red-800 bg-red-100 hover:bg-red-200">Apagar</button>
                                                    )}
                                                    <button onClick={() => exportToCSV([audit.id])} className="px-3 py-1 text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200" title="Exportar esta auditoria para CSV">CSV</button>
                                                </div>
                                            </td>
                                        </tr>
                                    )) : (
                                        <tr><td colSpan="7" className="text-center py-10 text-gray-500">Nenhuma auditoria encontrada com os filtros atuais.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        );
      }

      function ViewAuditPage({ setView, auditId, userData, notify, setLoading }) {
        const [audit, setAudit] = React.useState(null);
        const [entries, setEntries] = React.useState([]);
        const [loadingData, setLoadingData] = React.useState(true);
        const [errorData, setErrorData] = React.useState('');
        const [selectedImage, setSelectedImage] = React.useState(null);
        const [confirmAction, setConfirmAction] = React.useState(null);

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return null;
            // Can be a Firestore Timestamp or a JS Date object
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        React.useEffect(() => {
            if (!auditId) {
                setErrorData("Nenhuma auditoria selecionada.");
                setLoadingData(false);
                return;
            }
            const fetchAuditData = async () => {
                try {
                    const auditDoc = await getDoc(doc(db, "audits", auditId));
                    if (auditDoc.exists()) {
                        setAudit(auditDoc.data());
                    } else {
                        throw new Error("Auditoria não encontrada.");
                    }

                    const entriesSnapshot = await getDocs(collection(db, "audits", auditId, "entries"));
                    const entriesData = entriesSnapshot.docs.map(d => d.data());
                    entriesData.sort((a,b) => a.entryNumber - b.entryNumber);
                    setEntries(entriesData);
                } catch (e) {
                    console.error("Erro ao carregar auditoria para visualização:", e);
                    setErrorData(e.message);
                } finally {
                    setLoadingData(false);
                }
            };
            fetchAuditData();
        }, [auditId]);

        const handleDeleteAudit = async () => {
            setConfirmAction({
                message: "Tem certeza que deseja apagar esta auditoria permanentemente? Esta ação não pode ser desfeita.",
                color: 'red',
                onConfirm: async () => {
                    setLoading(true);
                    setConfirmAction(null);
                    try {
                        const entriesRef = collection(db, "audits", auditId, "entries");
                        const entriesSnapshot = await getDocs(entriesRef);
                        const deleteBatch = writeBatch(db);
                        entriesSnapshot.forEach(doc => {
                            deleteBatch.delete(doc.ref);
                        });
                        
                        deleteBatch.delete(doc(db, "audits", auditId));

                        await deleteBatch.commit();

                        notify("Auditoria apagada com sucesso!", "success");
                        setView('history');
                    } catch (err) {
                        console.error("Erro ao apagar auditoria:", err);
                        notify("Falha ao apagar a auditoria. Tente novamente.", "error");
                    } finally {
                        setLoading(false);
                    }
                }
            });
        };
        
        const exportToCSV = async (auditIdToExport) => {
            if (!auditIdToExport) {
                notify("ID da auditoria não encontrado.", "error");
                return;
            }

            setLoading(true);
            try {
                let entriesToExport = [];
                let fileName = `auditoria_${auditIdToExport}.csv`;

                const auditDoc = await getDoc(doc(db, "audits", auditIdToExport));
                if (!auditDoc.exists()) {
                    notify("Auditoria não encontrada.", "error");
                    setLoading(false);
                    return;
                }
                const auditData = auditDoc.data();

                const entriesSnapshot = await getDocs(collection(db, "audits", auditIdToExport, "entries"));
                entriesSnapshot.forEach(entryDoc => {
                    entriesToExport.push({ 
                        ...entryDoc.data(), 
                        userFullName: auditData.userFullName,
                        auditTitle: auditData.title
                    });
                });

                if (entriesToExport.length === 0) {
                    notify("Nenhum apontamento encontrado para exportar.", "warning");
                    setLoading(false);
                    return;
                }

                const headers = "Titulo_Auditoria,Numero_Apontamento,Auditor,Data_Hora_Apontamento,Zona_Operacional,Setor_Tecnico,Setor_Responsavel,Orgao_Anuente_Auditado,Local,Descricao_Apontamento,Complemento,Evidencia_1,Evidencia_2,Evidencia_3";
                const csvRows = [headers];

                entriesToExport.sort((a, b) => a.entryNumber - b.entryNumber).forEach(entry => {
                    const evidenceUrls = Object.values(entry.evidenceUrls || {});
                    const row = [
                        `"${entry.auditTitle || ''}"`,
                        entry.entryNumber,
                        `"${entry.userFullName || ''}"`,
                        `"${formatTimestamp(entry.entryTimestamp) || 'N/A'}"`,
                        `"${entry.operationalZone || ''}"`,
                        `"${entry.technicalSector || ''}"`,
                        `"${entry.responsibleSector || ''}"`,
                        `"${entry.auditedEntity || ''}"`,
                        `"${entry.location || ''}"`,
                        `"${(entry.description || '').replace(/"/g, '""')}"`,
                        `"${(entry.complement || '').replace(/"/g, '""')}"`,
                        // New image URL format
                        evidenceUrls[0] ? `https://drive.google.com/uc?id=${evidenceUrls[0]}` : '',
                        evidenceUrls[1] ? `https://drive.google.com/uc?id=${evidenceUrls[1]}` : '',
                        evidenceUrls[2] ? `https://drive.google.com/uc?id=${evidenceUrls[2]}` : '',
                    ];
                    csvRows.push(row.join(','));
                });

                const csvString = csvRows.join('\n');
                const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                notify("Exportação concluída!", "success");

            } catch (err) {
                console.error("Erro ao exportar CSV:", err);
                notify("Falha ao exportar CSV.", "error");
            } finally {
                setLoading(false);
            }
        };

        if (loadingData) return <div className="flex justify-center items-center h-screen"><div className="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div></div>;
        if (errorData) return <div className="p-8 text-center text-red-500">{errorData}</div>;

        return (
            <div className="p-4 md:p-8 max-w-4xl mx-auto">
                <ConfirmationModal action={confirmAction} onCancel={() => setConfirmAction(null)} />
                <header className="flex justify-between items-start mb-6">
                    <div>
                        <h1 className="text-2xl font-bold text-gray-800">{audit?.title || 'Visualizar Auditoria'}</h1>
                        <p className="text-sm text-gray-500 font-mono">{auditId}</p>
                    </div>
                    <button onClick={() => setView('history')} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg shadow-sm hover:bg-gray-50">Voltar ao Histórico</button>
                </header>
                <div className="space-y-6">
                    {entries.map((entry, index) => (
                        <div key={index} className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">Apontamento #{entry.entryNumber}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div className="bg-gray-50 p-3 rounded-lg"><strong>Órgão:</strong> {entry.auditedEntity}</div>
                                <div className="bg-gray-50 p-3 rounded-lg"><strong>Setor Responsável:</strong> {entry.responsibleSector}</div>
                                <div className="bg-gray-50 p-3 rounded-lg"><strong>Setor Técnico:</strong> {entry.technicalSector}</div>
                                <div className="bg-gray-50 p-3 rounded-lg"><strong>Zona:</strong> {entry.operationalZone}</div>
                                <div className="bg-gray-50 p-3 rounded-lg md:col-span-2"><strong>Local:</strong> {entry.location}</div>
                                <div className="bg-gray-50 p-3 rounded-lg md:col-span-2">
                                    <strong className="block mb-1">Apontamento:</strong>
                                    <p className="uppercase font-mono whitespace-pre-wrap">{entry.description}</p>
                                </div>
                                {entry.complement && (
                                    <div className="bg-gray-50 p-3 rounded-lg md:col-span-2">
                                        <strong className="block mb-1">Complemento:</strong>
                                        <p className="whitespace-pre-wrap">{entry.complement}</p>
                                    </div>
                                )}
                                <div className="md:col-span-2">
                                    <strong className="block mb-2">Evidências:</strong>
                                    <div className="flex flex-wrap gap-4">
                                        {entry.evidenceUrls && Object.keys(entry.evidenceUrls).length > 0 ? Object.values(entry.evidenceUrls).map((fileId, evIndex) => (
                                            <button key={evIndex} onClick={() => setSelectedImage(`https://drive.google.com/thumbnail?id=${fileId}&sz=w1280`)}>
                                                <img src={`https://drive.google.com/thumbnail?id=${fileId}&sz=s220`} alt={`Evidência ${evIndex + 1}`} className="w-32 h-32 object-cover rounded-lg shadow-md hover:scale-105 transition-transform cursor-pointer" />
                                            </button>
                                        )) : <p className="text-gray-500">Nenhuma evidência fotográfica.</p>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="mt-8 flex justify-end gap-4">
                    <button onClick={() => exportToCSV(auditId)} className="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                        <i className="fas fa-file-csv mr-2"></i> Exportar CSV
                    </button>
                    {audit && (userData.role === 'admin' || (audit.userId === userData.uid && audit.status === 'pending')) && (
                        <button onClick={handleDeleteAudit} className="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">
                            <i className="fas fa-trash-alt mr-2"></i> Apagar Auditoria
                        </button>
                    )}
                </div>


                {selectedImage && (
                    <div 
                        className="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-50"
                        onClick={() => setSelectedImage(null)}
                    >
                        <div className="relative max-w-4xl max-h-4/5 p-4" onClick={(e) => e.stopPropagation()}>
                             <button 
                                onClick={() => setSelectedImage(null)}
                                className="absolute -top-2 -right-2 m-4 text-white text-4xl font-bold hover:text-gray-300"
                            >
                                &times;
                            </button>
                            <img 
                                src={selectedImage} 
                                alt="Evidência em tamanho ampliado" 
                                className="max-w-full max-h-[80vh] object-contain rounded-lg" 
                            />
                        </div>
                    </div>
                )}
            </div>
        );
    }
      
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
</body>
</html>
